<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <input type="file" id="fileInput" />
    <progress
      id="uploadProgress"
      value="0"
      max="100"
      style="width: 100%"
    ></progress>
    <div id="uploadStatus"></div>

    <script>
      const apiUrl = "http://localhost:3000/upload-multi-part";
      const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB chunk size

      async function uploadFile(file) {
  const progressBar = document.getElementById('uploadProgress');
  const statusDiv = document.getElementById('uploadStatus');
  let uploadedBytes = 0;

  try {
    // Reset progress bar and status
    progressBar.value = 0;
    statusDiv.textContent = 'Starting upload...';

    // Step 1: Start the upload
    const startResponse = await fetch(apiUrl+'/start-upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fileName: file.name, fileType: file.type })
    });
    const { uploadId } = await startResponse.json();

    // Step 2: Upload parts
    const parts = [];
    const totalParts = Math.ceil(file.size / CHUNK_SIZE);
    for (let partNumber = 1; partNumber <= totalParts; partNumber++) {
      const start = (partNumber - 1) * CHUNK_SIZE;
      const end = Math.min(start + CHUNK_SIZE, file.size);
      const chunk = file.slice(start, end);

      const formData = new FormData();
      formData.append('fileName', file.name);
      formData.append('partNumber', partNumber.toString());
      formData.append('uploadId', uploadId);
      formData.append('fileChunk', chunk);

      const partResponse = await fetch(apiUrl+'/upload-part', {
        method: 'POST',
        body: formData
      });
      
      if (!partResponse.ok) {
        throw new Error(`Failed to upload part ${partNumber}: ${partResponse.statusText}`);
      }
      
      const { ETag } = await partResponse.json();
      parts.push({ PartNumber: partNumber, ETag });

      // Update progress
      uploadedBytes += chunk.size;
      const progress = (uploadedBytes / file.size) * 100;
      progressBar.value = progress;
      statusDiv.textContent = `Uploading... ${progress.toFixed(2)}% (Part ${partNumber}/${totalParts})`;
    }

    statusDiv.textContent = 'Finalizing upload...';

    // Step 3: Complete the upload
    const completeResponse = await fetch(apiUrl+'/complete-upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fileName: file.name, uploadId, parts })
    });
    
    if (!completeResponse.ok) {
      throw new Error(`Failed to complete upload: ${completeResponse.statusText}`);
    }

    const { fileUrl } = await completeResponse.json();
    console.log('Upload completed:', fileUrl);
    statusDiv.textContent = `Upload completed! File URL: ${fileUrl}`;
    progressBar.value = 100;
  } catch (error) {
    console.error('Upload failed:', error);
    statusDiv.textContent = `Upload failed: ${error.message}`;
  }
}

      // Usage
      document
        .getElementById("fileInput")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            uploadFile(file);
          }
        });
    </script>
  </body>
</html>
